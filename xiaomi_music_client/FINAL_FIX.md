# ğŸ”§ æœ€ç»ˆä¿®å¤ï¼šæ—¶åºé—®é¢˜

## é—®é¢˜æ ¹æº

æ‰¾åˆ°äº†ï¼é—®é¢˜æ˜¯**æ—¶åºé—®é¢˜**ï¼š

### é—®é¢˜æµç¨‹
```
1. ç”¨æˆ·ç™»å½•
   â†“
2. AuthWrapper ç«‹å³æ£€æŸ¥è®¾ç½®å¹¶é¢„åŠ è½½
   â†“
3. ä½†æ­¤æ—¶ sourceSettingsProvider è¿˜æœªåŠ è½½å®Œæˆ
   â†“
4. è¯»å–åˆ°çš„æ˜¯é»˜è®¤å€¼: primarySource='unified'
   â†“
5. åˆ¤æ–­æœªå¯ç”¨JSï¼Œè·³è¿‡é¢„åŠ è½½ âŒ
   â†“
6. åæ¥æœç´¢æ—¶ï¼Œè®¾ç½®å·²åŠ è½½: primarySource='js_external'
   â†“
7. å‘ç°æ˜¯JSæ¨¡å¼ï¼Œä½†è„šæœ¬æœªé¢„åŠ è½½
   â†“
8. æŠ¥é”™ï¼š"æœªå¯¼å…¥JSè„šæœ¬" âŒ
```

### æ—¥å¿—è¯æ®
```
[AuthWrapper] â„¹ï¸ æœªå¯ç”¨JSéŸ³æºï¼Œè·³è¿‡é¢„åŠ è½½  â† è®¾ç½®æœªåŠ è½½
...
[XMC] ğŸ”§ [MusicSearch] ä¸»è¦éŸ³æº: js_external  â† è®¾ç½®å·²åŠ è½½
[XMC] ğŸ“š [JsScriptManager] åŠ è½½äº† 1 ä¸ªè„šæœ¬     â† è„šæœ¬å­˜åœ¨
[XMC] ğŸ” searchOnline: error=Exception: æœªå¯¼å…¥JSè„šæœ¬ â† ä½†æœªé¢„åŠ è½½
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶
`lib/presentation/widgets/auth_wrapper.dart`

### å…³é”®æ”¹åŠ¨
**åœ¨æ£€æŸ¥è®¾ç½®ä¹‹å‰ï¼Œç­‰å¾…è®¾ç½®åŠ è½½å®Œæˆ**ï¼š

```dart
// âœ¨ æ–°å¢ï¼šç­‰å¾…è®¾ç½®åŠ è½½å®Œæˆ
final settingsNotifier = ref.read(sourceSettingsProvider.notifier);
int waitCount = 0;
while (!settingsNotifier.isLoaded && waitCount < 50) {
  await Future.delayed(const Duration(milliseconds: 100));
  waitCount++;
}

if (!settingsNotifier.isLoaded) {
  print('[AuthWrapper] âš ï¸ è®¾ç½®åŠ è½½è¶…æ—¶ï¼Œè·³è¿‡é¢„åŠ è½½');
  return;
}

// ç°åœ¨è®¾ç½®å·²ç»åŠ è½½å®Œæˆï¼Œå¯ä»¥å®‰å…¨è¯»å–
final settings = ref.read(sourceSettingsProvider);
print('[AuthWrapper] ğŸ“‹ éŸ³æºè®¾ç½®: primarySource=${settings.primarySource}');

if (settings.primarySource != 'js_external') {
  print('[AuthWrapper] â„¹ï¸ æœªå¯ç”¨JSéŸ³æºï¼Œè·³è¿‡é¢„åŠ è½½');
  return;
}
```

---

## ğŸ” ä¿®å¤åçš„æµç¨‹

```
1. ç”¨æˆ·ç™»å½•
   â†“
2. AuthWrapper è§¦å‘é¢„åŠ è½½é€»è¾‘
   â†“
3. âœ… ç­‰å¾…è®¾ç½®åŠ è½½å®Œæˆï¼ˆæœ€å¤š5ç§’ï¼‰
   â†“
4. è¯»å–åˆ°æ­£ç¡®çš„è®¾ç½®: primarySource='js_external'
   â†“
5. åˆ¤æ–­å·²å¯ç”¨JSï¼Œå¼€å§‹é¢„åŠ è½½ âœ…
   â†“
6. é¢„åŠ è½½å®Œæˆ
   â†“
7. æœç´¢æ—¶ï¼Œè„šæœ¬å·²å°±ç»ªï¼Œç›´æ¥ä½¿ç”¨ âœ…
```

---

## ğŸ§ª éªŒè¯æ–¹æ³•

### è¿è¡ŒAPP
```bash
flutter clean
flutter pub get
flutter run
```

### æŸ¥çœ‹æ—¥å¿—

**åº”è¯¥çœ‹åˆ°**ï¼ˆæŒ‰é¡ºåºï¼‰ï¼š
```
1. [Main] âœ… JSè¿è¡Œæ—¶é¢„åˆå§‹åŒ–å®Œæˆ
2. [UnifiedJS] âœ… JSè¿è¡Œæ—¶åˆå§‹åŒ–å®Œæˆ
3. [AuthWrapper] ğŸ”‘ æ£€æµ‹åˆ°ç™»å½•æˆåŠŸï¼Œå‡†å¤‡é¢„åŠ è½½JS
4. [AuthWrapper] ğŸ“‹ éŸ³æºè®¾ç½®: primarySource=js_external  â† æ–°å¢
5. [AuthWrapper] ğŸš€ å¼€å§‹åå°é¢„åŠ è½½JSè„šæœ¬: [è„šæœ¬å]
6. [UnifiedJS] ğŸ’¾ ä½¿ç”¨HTTPç¼“å­˜ æˆ– ğŸŒ ä»URLä¸‹è½½
7. [AuthWrapper] âœ… JSè„šæœ¬é¢„åŠ è½½å®Œæˆ
```

**æœç´¢æ—¶åº”è¯¥çœ‹åˆ°**ï¼š
```
[XMC] âœ… ä½¿ç”¨ç»Ÿä¸€JSæœåŠ¡ï¼ˆå·²é¢„åŠ è½½ï¼‰
[XMC] ğŸµ [MusicSearch] JSæµç¨‹ï¼ˆä½¿ç”¨åŸç”Ÿæœç´¢ + JSè§£ææ’­æ”¾ï¼‰
```

**ä¸åº”è¯¥å†çœ‹åˆ°**ï¼š
```
âŒ [AuthWrapper] â„¹ï¸ æœªå¯ç”¨JSéŸ³æºï¼Œè·³è¿‡é¢„åŠ è½½
âŒ Exception: æœªå¯¼å…¥JSè„šæœ¬
```

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰
```
è®¾ç½®åŠ è½½çŠ¶æ€: â³ åŠ è½½ä¸­...
AuthWrapperæ£€æŸ¥: è¯»å– â†’ primarySource='unified' (é»˜è®¤å€¼)
åˆ¤æ–­: æœªå¯ç”¨JS âŒ
ç»“æœ: è·³è¿‡é¢„åŠ è½½
```

### ä¿®å¤å
```
AuthWrapper: ç­‰å¾…è®¾ç½®åŠ è½½...
è®¾ç½®åŠ è½½çŠ¶æ€: âœ… å·²åŠ è½½
AuthWrapperæ£€æŸ¥: è¯»å– â†’ primarySource='js_external' (å®é™…å€¼)
åˆ¤æ–­: å·²å¯ç”¨JS âœ…
ç»“æœ: å¼€å§‹é¢„åŠ è½½
```

---

## âœ… éªŒæ”¶æ ‡å‡†

ç¡®è®¤ä»¥ä¸‹æ—¥å¿—é¡ºåºï¼š

1. [ ] å¯åŠ¨æ—¶ï¼š`[UnifiedJS] âœ… JSè¿è¡Œæ—¶åˆå§‹åŒ–å®Œæˆ`
2. [ ] ç™»å½•åï¼š`[AuthWrapper] ğŸ“‹ éŸ³æºè®¾ç½®: primarySource=js_external`
3. [ ] ç™»å½•åï¼š`[AuthWrapper] ğŸš€ å¼€å§‹åå°é¢„åŠ è½½JSè„šæœ¬`
4. [ ] ç™»å½•åï¼š`[AuthWrapper] âœ… JSè„šæœ¬é¢„åŠ è½½å®Œæˆ`
5. [ ] æœç´¢æ—¶ï¼š`[XMC] âœ… ä½¿ç”¨ç»Ÿä¸€JSæœåŠ¡ï¼ˆå·²é¢„åŠ è½½ï¼‰`
6. [ ] æœç´¢æ—¶ï¼š**ä¸å†æŠ¥é”™**"æœªå¯¼å…¥JSè„šæœ¬"

---

## ğŸ¯ æ€»ç»“

### é—®é¢˜
æ—¶åºç«äº‰ï¼šAuthWrapperåœ¨è®¾ç½®åŠ è½½å®Œæˆå‰å°±è¯»å–äº†é»˜è®¤å€¼

### ä¿®å¤
æ·»åŠ ç­‰å¾…é€»è¾‘ï¼Œç¡®ä¿è®¾ç½®åŠ è½½å®Œæˆåå†è¯»å–

### æ•ˆæœ
- âœ… æ­£ç¡®è¯†åˆ«JSéŸ³æºè®¾ç½®
- âœ… æ­£ç¡®é¢„åŠ è½½JSè„šæœ¬
- âœ… æœç´¢æ—¶è„šæœ¬å·²å°±ç»ª
- âœ… ä¸å†æŠ¥é”™

---

**ç°åœ¨è¿è¡Œæµ‹è¯•å§ï¼åº”è¯¥å®Œå…¨è§£å†³äº†ï¼** ğŸš€